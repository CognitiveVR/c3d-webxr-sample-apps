var Vr=pc.createScript("vr");Vr.attributes.add("buttonVr",{type:"entity",title:"VR Button"}),Vr.attributes.add("elementUnsupported",{type:"entity",title:"Unsupported Message"}),Vr.attributes.add("elementHttpsRequired",{type:"entity",title:"HTTPS Required Message"}),Vr.attributes.add("cameraEntity",{type:"entity",title:"Camera"}),Vr.prototype.initialize=function(){this.buttonVr.element.on("click",(function(){this.sessionCompatible()}),this),this.app.keyboard.on("keydown",(function(t){t.key===pc.KEY_ESCAPE&&this.app.xr.active&&this.app.xr.end()}),this),this.checkButton(!1),this.setEvents("on"),this.on("destroy",(function(){this.setEvents("off")}),this)},Vr.prototype.setEvents=function(t){this.app.xr[t]("available:"+pc.XRTYPE_VR,this.onAvailable,this),this.app.xr[t]("start",this.onStart,this),this.app.xr[t]("end",this.onEnd,this)},Vr.prototype.checkButton=function(t){if(this.app.xr.supported)if(this.elementHttpsRequired.enabled=!1,this.elementUnsupported.enabled=!1,t)this.buttonVr.enabled=!1;else{this.buttonVr.enabled=!0;var e=this.app.xr&&!this.app.xr.active&&this.app.xr.isAvailable(pc.XRTYPE_VR);this.buttonVr.element.opacity=e?.2:.1,this.buttonVr.children[0].element.opacity=e?1:.2}else this.buttonVr.enabled=!1,"https:"==window.location.protocol?(this.elementUnsupported.enabled=!0,this.elementHttpsRequired.enabled=!1):(this.elementUnsupported.enabled=!1,this.elementHttpsRequired.enabled=!0)},Vr.prototype.sessionCompatible=async function(){const t=this.app.graphicsDevice.gl;t.makeXRCompatible?t.makeXRCompatible().then((()=>{console.log("start camera after make XR compatible"),this.sessionStart()})).catch((t=>{console.error("Failed to make WebGL XR-compatible:",t)})):(console.log("start camera"),this.sessionStart())},Vr.prototype.sessionStart=function(){this.app.xr.supported&&(this.app.xr.active||this.app.xr.isAvailable(pc.XRTYPE_VR)&&this.cameraEntity.camera.startXr(pc.XRTYPE_VR,pc.XRSPACE_LOCAL))},Vr.prototype.onAvailable=function(){this.checkButton(!1)},Vr.prototype.onStart=function(){this.checkButton(!0)},Vr.prototype.onEnd=function(){this.checkButton(!1)};var Controllers=pc.createScript("controllers");Controllers.attributes.add("controllerTemplate",{type:"entity",title:"Controller Template"}),Controllers.attributes.add("cameraParent",{type:"entity",title:"Camera Parent"}),Controllers.prototype.initialize=function(){this.app.xr.input.on("add",(function(t){console.log("set input script");var e=this.controllerTemplate.clone();e.script.controller.setInputSource(t),e.reparent(this.cameraParent),e.enabled=!0}),this)};var Controller=pc.createScript("controller");Controller.prototype.initialize=function(){this.vecA=new pc.Vec3,this.vecB=new pc.Vec3,this.matA=new pc.Mat4,this.quat=new pc.Quat,this.color=new pc.Color(1,1,1),this.modelDefault=this.entity.findByName("model"),this.hoverEntity=null,this.targetPointerSize=2,this.targetTeleportable=!1,this.pointerDefault=this.entity.findByName("pointer"),this.pointerGrabbable=this.entity.findByName("pointer-grab"),this.pointerChangeColour=this.entity.findByName("pointer-change-colour"),this.pointer=this.pointerDefault;var t=this.pointerDefault.element,e=t.material.clone();t.material=e,e.depthTest=!1,t.material=e;var i=t.color.clone();t.color=new pc.Color(i.r,i.g+.01,i.b),t.color=i;var o=t.opacity;t.opacity=0,t.opacity=o,e.update(),this.hoverPoint=new pc.Vec3,this.pointerDistance=3,this.on("destroy",(function(){t.material=null,e.destroy(),this.inputSource&&(this.inputSource.off("selectstart",this.onSelect,this),this.inputSource.off("squeezestart",this.onSqueezeStart,this),this.inputSource.off("squeezeend",this.onSqueezeEnd,this),this.inputSource.off("remove",this.onRemove,this),this.inputSource.hand&&(this.inputSource.hand.off("trackinglost",null,this),this.inputSource.hand.off("tracking",null,this))),this.off("hover",this.onHover,this),this.off("blur",this.onBlur,this)}),this)},Controller.prototype.setInputSource=function(t){if(this.inputSource=t,this.inputSource.once("remove",this.onRemove,this),this.on("hover",this.onHover,this),this.on("blur",this.onBlur,this),this.inputSource.on("selectstart",this.onSelect,this),this.inputSource.on("squeezestart",this.onSqueezeStart,this),this.inputSource.on("squeezeend",this.onSqueezeEnd,this),t.hand){this.joints=[];var e=new pc.StandardMaterial,i=new pc.StandardMaterial;i.diffuse.set(0,.5,1);for(var o=0;o<t.hand.joints.length;o++){var n=t.hand.joints[o],r=new pc.Entity;r.addComponent("render",{type:"box"}),r.joint=n,r.render.material=n.tip?i:e,this.joints.push(r),this.entity.addChild(r)}t.hand.on("trackinglost",(function(){this.joints[0].render.material.diffuse.set(1,0,0),this.joints[0].render.material.update()}),this),t.hand.on("tracking",(function(){this.joints[0].render.material.diffuse.set(1,1,1),this.joints[0].render.material.update()}),this)}},Controller.prototype.onRemove=function(){this.entity.destroy()},Controller.prototype.onSelect=function(t){this.inputSource.handedness===t.inputSource.handedness&&(this.app.fire("object:pick",this),this.hoverEntity&&(this.hoverEntity.tags.has("interactive")?(console.log("change colour fired"),console.log("current pointer",this.pointer),this.colourChange(this.hoverEntity)):this.targetTeleportable&&(console.log("fire teleport"),this.app.fire("controller:teleport",this.hoverPoint,this))))},Controller.prototype.colourChange=function(t){var e=t.render.meshInstances[0];e.pickedColor||(e.pickedColor=new pc.Color),e.pickedColor.set(Math.random(),Math.random(),Math.random()),e.setParameter("material_diffuse",[e.pickedColor.r,e.pickedColor.g,e.pickedColor.b])},Controller.prototype.onSqueezeStart=function(t){this.inputSource.handedness===t.inputSource.handedness&&(this.app.fire("object:pick",this),this.hoverEntity&&this.hoverEntity.tags&&this.hoverEntity.tags.has("grabbable")&&this.app.fire("grab:start",this.hoverEntity,this))},Controller.prototype.onSqueezeEnd=function(){this.app.fire("grab:end",this)},Controller.prototype.onHover=function(t,e){this.hoverEntity=t,this.hoverPoint.copy(e),this.targetPointerSize=16,this.targetTeleportable=this.hoverEntity.tags.has("teleportable"),this.hoverEntity.tags.has("grabbable")?(this.pointerDefault&&(this.pointerDefault.enabled=!1),this.pointerGrabbable&&(this.pointerGrabbable.enabled=!0),this.pointerChangeColour&&(this.pointerChangeColour.enabled=!1)):this.hoverEntity.tags.has("interactive")?(this.pointerDefault&&(this.pointerDefault.enabled=!1),this.pointerGrabbable&&(this.pointerGrabbable.enabled=!1),this.pointerChangeColour&&(this.pointerChangeColour.enabled=!0)):(this.pointerDefault&&(this.pointerDefault.enabled=!0),this.pointerGrabbable&&(this.pointerGrabbable.enabled=!1),this.pointerChangeColour&&(this.pointerChangeColour.enabled=!1))},Controller.prototype.onBlur=function(){this.hoverEntity=null,this.targetPointerSize=4,this.targetTeleportable=!1,this.pointerDefault&&(this.pointerDefault.enabled=!0),this.pointerGrabbable&&(this.pointerGrabbable.enabled=!1),this.pointerChangeColour&&(this.pointerChangeColour.enabled=!1)},Controller.prototype.update=function(t){if(this.app.fire("object:pick",this),this.inputSource.hand){for(var e,i=0;i<this.joints.length;i++){var o=2*(e=this.joints[i].joint).radius;this.joints[i].setLocalScale(o,o,o),this.joints[i].setPosition(e.getPosition()),this.joints[i].setRotation(e.getRotation())}this.color.set(1,1,1);for(var n=this.inputSource.hand,r=n.wrist,s=0;s<n.fingers.length;s++)for(var h=null,a=0;a<n.fingers[s].joints.length;a++){e=n.fingers[s].joints[a];var l=h||r;this.vecA.copy(l.getPosition()),this.vecB.copy(e.getPosition()),this.app.drawLine(this.vecA,this.vecB,this.color),h=e}}if(this.inputSource.grip&&(this.modelDefault.enabled=!0,this.entity.setPosition(this.inputSource.getPosition()),this.entity.setRotation(this.inputSource.getRotation()),this.vecA.copy(this.inputSource.getOrigin()),this.vecB.copy(this.inputSource.getDirection()),this.vecB.scale(1e3).add(this.vecA),this.inputSource.selecting?this.color.set(0,1,0):this.color.set(1,1,1),this.app.drawLine(this.vecA,this.vecB,this.color)),this.hoverEntity){var p=this.vecA.copy(this.hoverPoint).sub(this.inputSource.getOrigin()).length();this.pointerDistance+=.3*(p-this.pointerDistance)}this.pointerDefault.enabled?this.pointer=this.pointerDefault:this.pointerChangeColour.enabled?this.pointer=this.pointerChangeColour:this.pointer=this.pointerGrabbable,this.vecA.copy(this.inputSource.getDirection()).scale(this.pointerDistance).add(this.inputSource.getOrigin()),this.pointer.setPosition(this.vecA);var c=this.targetPointerSize*(this.targetTeleportable?6:1);this.pointer.element.width!==c&&(this.pointer.element.width+=.3*(c-this.pointer.element.width),Math.abs(this.pointer.element.width-c)<=1&&(this.pointer.element.width=c),this.pointer.element.height=this.pointer.element.width),this.targetTeleportable?this.pointer.setEulerAngles(-90,0,0):this.app.xr.camera&&(this.pointer.lookAt(this.app.xr.camera.getPosition(),pc.Vec3.DOWN),this.pointer.rotateLocal(0,180,0));var u=this.inputSource.gamepad;u&&(this.inputSource.handedness===pc.XRHAND_LEFT&&(u.axes[3]||u.axes[2])?this.app.fire("controller:move",u.axes[2],u.axes[3],t):this.inputSource.handedness===pc.XRHAND_RIGHT&&u.axes[2]&&this.app.fire("controller:rotate",-u.axes[2],t))};var ObjectPicker=pc.createScript("objectPicker");ObjectPicker.prototype.initialize=function(){this.entities=this.app.root.findByTag("pickable"),this.ray=new pc.Ray,this.vec3A=new pc.Vec3,this.vec3B=new pc.Vec3,this.app.on("object:pick",this.pick,this),this.on("destroy",(function(){this.app.off("object:pick",this.pick,this)}),this)},ObjectPicker.prototype.pick=function(i){var t=null,e=1/0;this.ray.set(i.inputSource.getOrigin(),i.inputSource.getDirection());for(var s=0;s<this.entities.length;s++)if(this.entities[s].render){var c=this.entities[s].render.meshInstances[0];if(!this.entities[s].tags.has("ray-ignore")&&c.aabb.intersectsRay(this.ray,this.vec3A)){var r=this.vec3A.distance(this.ray.origin);if(r<e)e=r,t=this.entities[s].parent&&this.entities[s].parent.tags.has("grabbable")?this.entities[s].parent:this.entities[s],this.vec3B.copy(this.vec3A)}}t?i.fire("hover",t,this.vec3B):i.hoverEntity&&i.fire("blur")};var CameraController=pc.createScript("camera-controller");CameraController.attributes.add("height",{type:"number",default:1.6,placeholder:"m",title:"Height from Floor"}),CameraController.attributes.add("movementSpeed",{type:"number",default:1.5,placeholder:"m/s",title:"Movement Speed"}),CameraController.attributes.add("rotateSpeed",{type:"number",default:45,placeholder:"°",title:"Rotation Speed"}),CameraController.attributes.add("rotateThreshold",{type:"number",default:.5,min:0,max:1,title:"Rotation thumbstick threshold"}),CameraController.attributes.add("rotateResetThreshold",{type:"number",default:.25,min:0,max:1,title:"Rotation thumbstick reset threshold"}),CameraController.attributes.add("camera",{type:"entity",title:"Camera Entity"}),CameraController.attributes.add("rb",{type:"entity"}),CameraController.prototype.initialize=function(){this.vec2A=new pc.Vec2,this.vec2B=new pc.Vec2,this.vec3A=new pc.Vec3,this.lastRotate=0,this.lastRotateValue=0,this.minX=-5,this.maxX=5,this.minY=-5,this.maxY=5,this.isRotating=!1,this.app.on("controller:teleport",this.onTeleport,this),this.app.on("controller:move",this.onMove,this),this.app.on("controller:rotate",this.onRotate,this),this.on("destroy",(function(){this.app.off("controller:teleport",this.onTeleport,this),this.app.off("controller:move",this.onMove,this),this.app.off("controller:rotate",this.onRotate,this)}),this)},CameraController.prototype.onTeleport=function(t,e){this.app.xr.type!==pc.XRTYPE_AR&&(console.log("teleport from ",this.entity.getPosition(),"to",t),this.vec3A.copy(this.camera.getLocalPosition()).scale(-1),this.entity.setPosition(t),this.entity.translate(0,this.height,0))},CameraController.prototype.onMove=function(t,e,o){if(this.lastPosition=this.entity.getPosition().clone(),this.vec2A.set(t,e),this.vec2A.length()){this.vec2A.normalize(),this.vec2B.x=this.camera.forward.x,this.vec2B.y=this.camera.forward.z,this.vec2B.normalize();var a=Math.atan2(this.vec2B.x,this.vec2B.y)-Math.PI/2,i=this.vec2A.x*Math.sin(a)-this.vec2A.y*Math.cos(a);this.vec2A.y=this.vec2A.y*Math.sin(a)+this.vec2A.x*Math.cos(a),this.vec2A.x=i,this.vec2A.scale(this.movementSpeed);var s=this.vec2A.clone();s.x=pc.math.clamp(s.x,this.minX,this.maxX),s.y=pc.math.clamp(s.y,this.minY,this.maxY),this.entity.translate(s.x*o,0,s.y*o)}},CameraController.prototype.onRotate=function(t,e){if(!(Date.now()-this.lastRotate<200)){if(0!==this.lastRotateValue)if(this.lastRotateValue>0){if(!(t<this.rotateResetThreshold))return;this.lastRotateValue=0}else{if(!(t>-this.rotateResetThreshold))return;this.lastRotateValue=0}Math.abs(t)>this.rotateThreshold&&(this.lastRotateValue=Math.sign(t),this.vec3A.copy(this.camera.getLocalPosition()),this.entity.translateLocal(this.vec3A),this.entity.rotateLocal(0,Math.sign(t)*this.rotateSpeed,0),this.entity.translateLocal(this.vec3A.scale(-1)))}};var Grabbing=pc.createScript("grabbing");Grabbing.prototype.initialize=function(){this.grabbedEntity=null,this.templateRoot=null,this.closestSocket=null,this.app.on("grab:start",this.onGrabStart,this),this.app.on("grab:end",this.onGrabEnd,this),this.on("destroy",(function(){this.app.off("grab:start",this.onGrabStart,this),this.app.off("grab:end",this.onGrabEnd,this)}),this)},Grabbing.prototype.findParentRoot=function(t){for(var i=t;i.parent;){if(i.tags&&i.tags.has("parent-root"))return i;i=i.parent}return null},Grabbing.prototype.onGrabStart=function(t,i){if(!this.grabbedEntity&&t&&t.tags&&(t.tags.has("grabbable")||t.tags.has("has-parent"))){t.tags.has("has-parent")?this.grabbedEntity=t.parent:this.grabbedEntity=t,this.templateRoot=this.findParentRoot(this.grabbedEntity),console.log("pick up obj w/ the original parent",this.templateRoot);var e=i.entity.getPosition(),a=t.getPosition();if(e.distance(a)>this.grabbedEntity.script.grabItem.maxGrabDistance)console.log("Obj too far for grab");else this.grabbedEntity.rigidbody&&(this.grabbedEntity.rigidbody.enabled=!1,this.grabbedEntity.rigidbody._type="kinematic",this.grabbedEntity.rigidbody.enabled=!0),i.entity.addChild(this.grabbedEntity),this.grabbedEntity.setLocalPosition(0,0,-.2),console.log("Grabbed via event:",this.grabbedEntity.name)}},Grabbing.prototype.onGrabEnd=function(){if(this.grabbedEntity){if(this.grabbedEntity){for(var t=this.app.root.findByTag("socket"),i=1,e=this.grabbedEntity.getPosition(),a=0;a<t.length;a++){var n=t[a].getPosition(),o=e.distance(n);o<i&&(i=o,this.closestSocket=t[a])}var s=this.grabbedEntity.getPosition().clone(),b=this.grabbedEntity.getRotation().clone();if(this.templateRoot?this.templateRoot.addChild(this.grabbedEntity):this.app.root.addChild(this.grabbedEntity),this.closestSocket){if(console.log("snap to socket",this.closestSocket.name),this.grabbedEntity.rigidbody&&(this.grabbedEntity.rigidbody.enabled=!1),this.grabbedEntity.setPosition(this.closestSocket.getPosition().add(new pc.Vec3(0,.1,0))),this.grabbedEntity.script&&this.grabbedEntity.script.grabItem){var r=this.grabbedEntity.script.grabItem.originalRotation;this.grabbedEntity.setRotation(r)}for(a=0;a<this.grabbedEntity.children.length;a++){var d=this.grabbedEntity.children[a];d.collision&&(d.collision.enabled=!1,d.tags.add("ray-ignore"))}this.grabbedEntity.tags.remove("grabbable"),this.app.fire("socket:filled",this.closestSocket),this.closestSocket=null}else{this.grabbedEntity.setPosition(s),this.grabbedEntity.setRotation(b),this.grabbedEntity.rigidbody&&(this.grabbedEntity.rigidbody.enabled=!1,this.grabbedEntity.rigidbody.type="dynamic",this.grabbedEntity.rigidbody.enabled=!0)}console.log("dropped object",this.grabbedEntity.name)}this.grabbedEntity=null,this.templateRoot=null,this.grabDistance=0}};var GrabItem=pc.createScript("grabItem");GrabItem.attributes.add("maxGrabDistance",{type:"number",default:3,title:"Max Grab Distance"}),GrabItem.attributes.add("Original Rotation",{type:"vec4",default:[0,0,0,1]}),GrabItem.prototype.initialize=function(){this.originalRotation=this.entity.getRotation().clone(),this.originalPosition=this.entity.getPosition().clone(),this.originalParent=this.entity.parent,this.entity.tags.add("grabbable")};var ExitVrButton=pc.createScript("exitVrButton");ExitVrButton.prototype.initialize=function(){this.entity.enabled=!1,this.app.xr.on("start",(function(){this.entity.enabled=!0}),this),this.app.xr.on("end",(function(){this.entity.enabled=!1}),this),this.entity.button.on("click",this.onClick,this),this.on("destroy",(function(){this.entity.button.off("click",this.onClick,this)}),this)},ExitVrButton.prototype.onClick=function(){console.log("press button and close"),this.app.xr&&this.app.xr.active&&this.app.xr.end()};var SocketManager=pc.createScript("socketManager");SocketManager.prototype.initialize=function(){console.log("initialize socket m"),this.sockets=this.app.root.findByTag("socket"),this.counterText=this.app.root.findByName("potCounter"),this.finishScreen=this.app.root.findByName("FinishScreen"),this.filledCount=0;for(var t=0;t<this.sockets.length;t++)this.sockets[t]._filled=!1;this.app.on("socket:filled",this.onSocketFilled,this),this.updateCounter(),this.on("destroy",(function(){this.app.off("socket:filled",this.onSocketFilled,this)}),this)},SocketManager.prototype.onSocketFilled=function(t){t._filled||(t._filled=!0,this.filledCount++,this.updateCounter(),console.log("filled a pot",this.filledCount),this.filledCount==this.sockets.length&&this.showFinishScreen())},SocketManager.prototype.updateCounter=function(){this.counterText&&this.counterText.element&&(this.counterText.element.text="Pots filled: "+this.filledCount+" / "+this.sockets.length)},SocketManager.prototype.showFinishScreen=function(){this.finishScreen&&(this.finishScreen.enabled=!0,this.counterText.enabled=!1,console.log("enabled finish screen"))};var EndButtons=pc.createScript("endButtons");EndButtons.prototype.initialize=function(){this.infoScreen=this.app.root.findByName("FinishScreen"),this.endScreen=this.app.root.findByName("EndScreen"),this.camParent=this.app.root.findByName("Camera Parent"),console.log("camParent",this.camParent),this.entity.button.on("click",this.onClick,this),this.on("destroy",(function(){this.entity.button.off("click",this.onClick,this)}),this)},EndButtons.prototype.onClick=function(){if(this.infoScreen.enabled=!1,this.entity.tags.has("next-scene")){const e=this.app.scenes.find("VR Scene 2");var t=this.app.root.findByTag("disable-entity");if(t)for(i=0;i<t.length;i++)t[i].enabled=!1;this.camParent.setPosition(0,1.638,3.769),this.app.scenes.loadSceneHierarchy(e,(function(t){t?console.error(t):console.log("load additive scene",e.name)})),this.endScreen.enabled=!0}else if(this.entity.tags.has("restart")){var e=this.app.scenes.find("VR Scene");this.app.xr&&this.app.xr.active&&(this.app.xr.end(),this.app.xr.input.off("add",null,this)),this.app.scenes.changeScene(e,(function(t){t?console.error(t):console.log("restart scene")}))}else this.entity.tags.has("exit")&&this.app.xr&&this.app.xr.active&&this.app.xr.end()};